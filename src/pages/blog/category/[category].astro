---
import Layout from "../../../layouts/Layout.astro";
import PostCard from "../../../components/PostCard.astro";
import CategoryPills from "../../../components/blog/CategoryPills.astro";

// Generates dynamic routes for every category found in markdown posts
export async function getStaticPaths() {
    const allPosts = await Astro.glob("../*.md");

    // Extract unique categories
    const uniqueCategories = [
        ...new Set(
            allPosts.map((post) => post.frontmatter.category).filter(Boolean),
        ),
    ];

    // Return an array of route objects with params and props
    return uniqueCategories.map((category) => {
        const filteredPosts = allPosts.filter(
            (post) => post.frontmatter.category === category,
        );

        // Sort the posts by date, newest first
        filteredPosts.sort(
            (a, b) =>
                new Date(b.frontmatter.date).valueOf() -
                new Date(a.frontmatter.date).valueOf(),
        );

        return {
            params: { category },
            props: { posts: filteredPosts },
        };
    });
}

// Get the matched category from the URL and passing the posts prop
const { category } = Astro.params;
const { posts } = Astro.props;

// Re-fetch all posts to get unique categories for the pills
const allPosts = await Astro.glob("../*.md");
const categories = [
    ...new Set(
        allPosts.map((post: any) => post.frontmatter.category).filter(Boolean),
    ),
];
---

<Layout
    title={`Category: ${category}`}
    description={`Read all posts about ${category}`}
>
    <header class="container">
        <h1 class="h1">Category: <span>{category}</span></h1>
        <p>
            Explore all {posts.length}
            {posts.length === 1 ? "post" : "posts"} written in the <strong
                >{category}</strong
            > category.
        </p>

        <CategoryPills categories={categories} activeCategory={category} />
    </header>

    <div class="container post-container">
        {posts.map((post: any) => <PostCard post={post} />)}
    </div>
</Layout>
